# Налаштування NodeJS та NGINX на VPS сервері, для розміщення скриптів NodeJS та Python

Оскільки heroku стає(в) платним, а ціни на VPS по співвідношенні до курсу долара цілком адекватні (100 грн/міс), то було прийнято рішення перенести бекенд свого невеличкого проекту та скрипт телеграм-бота власне на VPS. Декілька днів тестів та пошуку інформації, і це дозволило написати цю покрокову інструкцію, яка зекономить час першочергово мені в майбутньому, а також, можливо, стане ще комусь в пригоді) Вай нот!?)

В якості VPS в моєму випадку було обрано VM з наступними характеристиками:
- 1 CPU (Intel Xeon E5-2680 v4 до 3.3GHz)
- 1 Gb RAM 
- 20 Gb DataStorage
- OS Ubuntu 22.04 LTS

------

## Встановлення NodeJS

Перед цим варто ще оновити всі пакети OS, скориставшись командою:

`
  sudo apt-get update
`

Оскільки мені необхідна остання версія NodeJS, а в репозиторіях Ubuntu моєї VPS доступна версія NodeJS 12.22.9, то ми скористаємось PPA наданим NodeSource. В своєму прикладі я використовуватиму версію 18.х, ви ж можете замінити на версію, яка потрібна Вам. PPA містись безліч версій, більше детально про це можна прочитати в [документації](https://github.com/nodesource/distributions/blob/master/README.md).

Для завантаження потрібної версії PPA. скористаємось командою:

`
  curl -sL https://deb.nodesource.com/setup_18.x -o nodesource_setup.sh
`

А після цього встановимо PPA, відкривши його через bash:

`
 sudo bash nodesource_setup.sh
`

Після цього PPA буде додано до нашої поточної конфігурації, а відповідно і наш локальний кеш пакетів буде оновлено автоматично. Тому ми можемо тепер через наступну команду встановити Node.js:

`
 sudo apt install nodejs
`

Щоб переконатись, що все встановилось і перевірити версію, введіть:

`
  node -v
`

Також зверніть увагу на те, що разом з NodeJS також встановився менеджер пакетів NPM, тому додатково його встановлювати не потрібно.

Впринципі, тепер ми можемо вигрузити на сервер наш проет, встановити всі залежності та запустити його, от тільки він працюватиме виключно на нашому локальному хосту з вказаним в конфігурації порту. Але ж нам потрібно мати доступ до нього ззовні, звертаючись напряму до домена. Для цих цілей ми налаштуємо NGINX в якості зворотнього проксі сервера.

------

## Встановлення NGINX та налаштування в якості зворотнього проксі сервера

Для коректної роботи https та уникнення проблем сертифікації SSL, бажано одразу налаштувати домен для VPS. Щоб зекономити, можна скористатись безкоштовним доменом в зоні .pp.ua або ж будь яким іншим, який Вам довподоби. 

Тому встановимо nginx командою:

`
  sudo apt-get install nginx
`

Після цього, встановлюємо certbot клієнт для автоматичного створення та встановлення сертифікату SSL. Для цього вводимо команду:

`
  sudo apt-get install certbot python3-certbot-nginx
`

Після цього налаштуємо certbot клієнт, ввівши команду з нашим доменом. Зверніть увагу, що замість elxserver.pp.ua необхідно вказати домен Вашого VPS серверу.

`
  sudo certbot --nginx -d elxserver.pp.ua -d www.elxserver.pp.ua
`

Після старту команди, клієнт запрпоонує ввести ваш емейл, а також дасть додаткові запитання. Після чого ви маєте отримати щось на зразок *"Congratulations! You have successfully enabled HTTPS on https://elxserver.pp.ua and https://www.elxserver.pp.ua"*

Для того, щоб сертифікат автоматично поновлювався кожні 30 днів, прописуємо команду:

`
  sudo certbot renew --dry-run
`

Тепер саме найцікавіш, необхідно змінити конфігурацію доменних імен. Сам код конфігурації знаходиться в файлі **[nginx_https_config](https://github.com/andrii-petlovanyi/nginx-nodejs_mysetup/blob/main/nginx_https_config)**! Тільки перед цим замініть elxserver.pp.ua на Ваш домен. А також вкажіть порт, на якому працюватиме ваш скрипт NodeJS (в моєму випадку, це 3002 порт), щоб nginx міг правильно перенаправляти. Для редагування актуального кофігуратора пропишіть команду з шляхом:

`
  sudo vim /etc/nginx/sites-available/default
`

Після даних маніпуляцій все повинно працювати по https та з редіректом з www. 

-----

## Встановлення менеджера процесів PM2

Для того щоб наш скрипт автоматично перезапускався в разі падіння серверу чи будь яких інших траблів, нам потрібно встановити спеціальний менеджер, який повністю сам кгнтролюватиме всі ці процеси. Для цього через наступну команду встановимо наш PM2:

`
  npm install pm2 -g
`

Зверніть увагу на префікс *-g*, це означає, що ми встановимо менеджер на глобальному рівні.

Після успішного встановлення, прееходимо в репозиторій нашого скрипта, та запускаємо наступну команду, де index.js це наш основний файл скрипта для старту:

`
  pm2 start index.js
`

Для відновлення та запуску списку процесів у разі перезапуску або непередбаченого збою сервера, збережіть поточну конфігурацію на диск виконавши команду save.

`
  pm2 save
` 

Більш детально про додаткові команди та можливості цього менеджера можна прочитати [ось тут](https://pm2.keymetrics.io/docs/usage/startup/))

-----

## Встановлення Supervisor для контролю роботи скрипта python-бота

Як вже писав вище, додадково в мене є телеграм-бот, написаний на python. Тому додатково мені потрібен ще й менеджер, який контролюватиме роботу і цього скрипта. Варіантів вирішення цієї задачі можна знайти достатньо, але мені найбільше приглянувся **Supervisor**. Протестувавши 5 днів його роботу, жодних нюансів не помітив. Тому додатково розпишу мої кроки по встановленні цього менеджера. 

Виконаємо обидві команди для встановлення:

`
  sudo apt-get install supervisor
  sudo python3 -m pip install supervisor
`

Також додамо менеджер в автозапуск:

`
sudo systemctl enable supervisor --now
`

Далі потрібно зберегти базовий файл конфігурацію за наступним шляхом:

`
echo_supervisord_conf > /etc/supervisor/supervisord.conf
`

Тепер відкриємо файл конфігурації:

`
  sudo vim /etc/supervisor/supervisord.conf
`

А тепер, щоб супервізор знав про існування нашого боту, та міг управляти ним, нам потрібно додати наступний код, тільки перед цим замініть імя main на імя вашого скрипта, а також вкажіть шлях до середовища venv та самого скрипта. Сам скрипт в цьому ж репозиторію під назвою **[supervisor_config](https://github.com/andrii-petlovanyi/nginx-nodejs_mysetup/blob/main/supervisor_config)**. 

_Зверніть увагу, конфігурацію дану Ви можете при потребі змінити під себе, чи навіть забрати непотрібні параметри. Цей конфіг писався під мої потреби._

Тепер зберігаємо конфіг (:wq), та кажемо менеджеру, щоб заново проініцілізував конфігуратор, запустивши команду:

`
  sudo supervisorctl reread
`

А також запускаємо наш менеджер командою:

`
  sudo supervisorctl start all
`

Щоб переглянути статус роботи Supervisor, можна скористатись командою:

`
  sudo supervisorctl status
`

-----

Ось і все)
Надалі з виходом будь яких змін, даний гайд буде оновлюватись.
Якщо виникнуть запитання, звертайтесь - **andrey.petlovany@gmail.com** 

-----

_**(c) Andrii Petlovanyi**_
